{% extends "base.html" %} {% block content %}

<head>
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/components/chats.css') }}"
  />
</head>

<div class="container-fluid">
  <div class="chat-container-fluid">
    <div class="text-center mt-3">
      <h2 class="mb-2 fw-bold text-primary">Join Our Chat Community</h2>
      <p class="mb-3 text-muted fst-italic">
        Discover and connect with fellow members.
      </p>
    </div>

    <div class="chat-container">
      <!-- Contacts Sidebar -->
      <div class="chat-sidebar">
        <h3 class="fw-bold mt-3">Contacts</h3>
        <ul class="contacts-list">
          {% for user in all_users %}
          <li class="contact-item">
            <button
              href=""
              data-receiver-id="{{ user.id }}"
              data-bs-target="#chatMessagesConversationArea{{ user.id }}"
              onclick="selectContact('{{ user.id }}')"
            >
              <img
                src="https://via.placeholder.com/50"
                alt="{{ user.first_name }}"
              />
              <div>
                <h6>{{ user.first_name }} {{ user.last_name }}</h6>
                <p>Online</p>
              </div>
              <span class="unread-badge">
                {{ unread_message_counts[user.id] or 0 }}
              </span>
            </button>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Chat Area -->
      <div class="chat-area" id="chatMessagesConversationArea">
        <div id="chatMessagesConversationAreaLabel">
          <h4 class="fw-bold mb-2">Chats</h4>
          <!-- No Conversation Message -->
          <p id="noConversationMessage" class="d-none">
            No conversation with this user at the moment.
          </p>
          <!-- Chat Messages List -->
          <ul class="message-list" id="messageList">
            <!-- Messages will be loaded dynamically here -->
            {% for message in all_messages %}

            <!-- Incoming Messages -->
            {% if message.receiver_id == current_user.id %}
            <li class="message-item incoming">
              <div class="message-content">
                <p>{{ message.content }}</p>
                <p class="message-time">
                  <span>{{ message.timestamp.strftime('%H:%M') }}</span>
                </p>
              </div>
            </li>
            {% endif %}

            <!-- Outgoing Messages -->
            {% if message.sender_id == current_user.id %}
            <li class="message-item outgoing">
              <div class="message-content">
                <p>{{ message.content }}</p>
                <p class="message-time">
                  <span>{{ message.timestamp.strftime('%H:%M') }}</span>
                </p>
              </div>
            </li>
            {% endif %} {% endfor %}
          </ul>

          <!-- Message Input -->
          <div class="message-input">
            <form
              method="post"
              action="{{ url_for('accounts.messages.messages') }}"
              id="sendMessageForm"
            >
              <!-- CSRF Token -->
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              <input
                type="hidden"
                name="receiver_id"
                id="receiverId"
                value=""
              />
              <input
                type="text"
                name="content"
                id="connect"
                placeholder="Type your message..."
              />
              <button type="submit"><ion-icon name="send"></ion-icon></button>
            </form>
          </div>
        </div>
      </div>

      <script>
        function selectContact(userId) {
          // Set the selected contact's ID in the message input form
          document.getElementById("receiverId").value = userId;
          // Load conversation messages for the selected contact
          loadConversationMessages(userId);
        }

        function loadConversationMessages(userId) {
          // AJAX request to fetch conversation messages for the selected contact
          $.ajax({
            url: "/messages", // URL endpoint to fetch messages
            type: "GET",
            data: { user_id: userId }, // Pass the selected user's ID as data
            success: function (response) {
              if (response.trim() === "") {
                // If no conversations are found, display the no conversation message
                document.getElementById("messageList").innerHTML = "";
                document
                  .getElementById("noConversationMessage")
                  .classList.remove("d-none");
              } else {
                // Replace the content of the message list with the fetched messages
                document.getElementById("messageList").innerHTML = response;
                // Hide the no conversation message
                document
                  .getElementById("noConversationMessage")
                  .classList.add("d-none");
              }
            },
            error: function (error) {
              console.log("Error loading conversation messages:", error);
            },
          });
        }
      </script>
    </div>

    <!-- Table with Conversation Message -->
    <div class="container-fluid">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">id</th>
            <th scope="col">Sender</th>
            <th scope="col">Receiver</th>
            <th scope="col">Content</th>
            <th scope="col">Timestamp</th>
          </tr>
        </thead>
        <tbody>
          {% for message in all_messages %}
          <tr>
            <th scope="row">{{ loop.index }}</th>
            <td>{{ message.id }}</td>
            <td>{{ message.sender_id }}</td>
            <td>{{ message.receiver_id }}</td>
            <td>{{ message.content }}</td>
            <td>{{ message.timestamp }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
