{% extends "base.html" %} {% block content %}

<!-- #MAIN BODY SECTION -->
<div class="container-fluid">
  <div class="card-header fw-bold border-0 fs-5 mt-1">
    <span class="me-2"><i class="bi bi-bar-chart-fill"></i></span>
    Dashboard
  </div>

  <!-- Four Bootstrap Cards -->
  <div class="row px-3 text-dark">
    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm bg-primary h-100 bg-opacity-50">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3 text-center">
              <ion-icon name="people" style="font-size: 2rem"></ion-icon>
            </div>
            <div class="col-md-9">
              <div class="card-text fs-6">{{ total_houses }} Houses</div>
              <div class="card-title fw-bold fs-5">Connections</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm bg-warning h-100 bg-opacity-50">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3 text-center">
              <ion-icon name="cash" style="font-size: 2rem"></ion-icon>
            </div>
            <div class="col-md-9">
              <div class="card-text fs-6">KES {{ total_revenue }}</div>
              <div class="card-title fw-bold fs-5">Revenue</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm bg-info h-100 bg-opacity-50">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3 text-center">
              <ion-icon name="water" style="font-size: 2rem"></ion-icon>
            </div>
            <div class="col-md-9">
              <div class="card-text fs-6">{{ total_consumption }} Units</div>
              <div class="card-title fw-bold fs-5">Consumption</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card border-0 shadow-sm bg-danger h-100 bg-opacity-50">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-3 text-center">
              <ion-icon name="cash" style="font-size: 2rem"></ion-icon>
            </div>
            <div class="col-md-9">
              <div class="card-text fs-6">KES {{ total_expenses }}</div>
              <div class="card-title fw-bold fs-5">Expenses</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Data -->
  <div class="row px-3">
    <!-- Bar Chart -->
    <div class="col-md-9 mb-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Performance Overview</h5>
          <div class="row">
            <div class="col-md-4 text-center p-3">
              <p class="text-muted mb-2">Overview Of Latest Month</p>
              <b class="fw-bold mb-3 h5" id="currentMonthEarnings">KES 0.00</b>
              <p class="text-muted mb-2">Current Month Earnings</p>
              <b class="fw-bold mb-3 h5" id="currentMonthWater">0 Units</b>
              <p class="text-muted mb-2">Water Consumed</p>

              <div
                class="input-group input-group-sm justify-content-between mt-5"
              >
                <button
                  class="btn btn-info me-1"
                  type="button"
                  onclick="previousMonth()"
                >
                  Previous
                </button>
                <button
                  class="btn btn-success"
                  type="button"
                  onclick="currentMonth()"
                >
                  Current
                </button>
              </div>
            </div>

            <div class="col-md-8">
              <canvas class="chart1" width="400" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Define myChart variable outside the scope to make it accessible globally
      let myChart;

      // Wait for the DOM content to load
      document.addEventListener("DOMContentLoaded", function () {
        const chart1 = document.querySelectorAll(".chart1");

        chart1.forEach(function (chart) {
          var ctx = chart.getContext("2d");

          // Function to generate random data for water consumed and revenue for each month
          function generateRandomData() {
            var waterData = [];
            var revenueData = [];
            for (var i = 0; i < 12; i++) {
              waterData.push(Math.floor(Math.random() * 700)); // Adjust the range as needed for water consumed
              revenueData.push(Math.floor(Math.random() * 1000)); // Adjust the range as needed for revenue
            }
            return {
              water: waterData,
              revenue: revenueData,
            };
          }

          var data = generateRandomData();

          myChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: [
                "Jan",
                "Feb",
                "Mar",
                "Apr",
                "May",
                "Jun",
                "Jul",
                "Aug",
                "Sep",
                "Oct",
                "Nov",
                "Dec",
              ],
              datasets: [
                {
                  label: "Water Consumed",
                  data: data.water,
                  backgroundColor: "rgba(54, 162, 235, 0.6)", // Use a single color for water consumed across all months
                  borderColor: "rgba(54, 162, 235, 1)",
                  borderWidth: 1,
                  barThickness: 8, // Adjust the thickness of the bars
                  borderRadius: 15, // Adjust the rounding of the bar ends
                },
                {
                  label: "Revenue",
                  data: data.revenue,
                  backgroundColor: "rgba(255, 99, 132, 0.6)", // Use a different color for revenue across all months
                  borderColor: "rgba(255, 99, 132, 1)",
                  borderWidth: 1,
                  barThickness: 8, // Adjust the thickness of the bars
                  borderRadius: 15, // Adjust the rounding of the bar ends
                },
              ],
            },
            options: {
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
              },
              scales: {
                y: {
                  beginAtZero: false,
                  grid: {
                    color: "rgba(0, 0, 0, 0.1)", // Adjust the color of the grid lines
                  },
                },
              },
            },
          });
        });
      });

      // Function to update the current month earnings and water consumed
      function updateData() {
        // Fetch actual data for the selected month (replace with your actual data fetching logic)
        const actualEarnings =
          "KES " + (Math.floor(Math.random() * 50000) + 50000).toFixed(2); // Random earnings between 50000 and 100000
        const actualWater = Math.floor(Math.random() * 500) + 500 + " Units"; // Random water between 500 and 1000 units

        // Update the HTML with the fetched data
        document.getElementById("currentMonthEarnings").innerText =
          actualEarnings;
        document.getElementById("currentMonthWater").innerText = actualWater;
      }

      // Simulate fetching actual data for the current month when the page loads
      updateData();
    </script>

    <!-- Doughnut Chart -->
    <div class="col-md-3 mb-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Overview Performance</h5>
          <canvas class="chart2" width="400" height="200"></canvas>
        </div>
      </div>
    </div>

    <script>
      const chart2 = document.querySelectorAll(".chart2");

      chart2.forEach(function (chart) {
        var ctx = chart.getContext("2d");

        // Function to generate random data for doughnut chart
        function generateRandomData() {
          return [
            Math.floor(Math.random() * 1000),
            Math.floor(Math.random() * 1000),
            Math.floor(Math.random() * 1000),
          ];
        }

        var data = generateRandomData();

        var myChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Invoice", "Payment", "Units"],
            datasets: [
              {
                label: "# of Votes",
                data: data,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.4)",
                  "rgba(54, 162, 235, 0.4)",
                  "rgba(255, 206, 86, 0.4)",
                ],
                borderColor: [
                  "rgba(255, 99, 132, 0.2)",
                  "rgba(54, 162, 235, 0.2)",
                  "rgba(255, 206, 86, 0.2)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            layout: {
              padding: {
                top: 20,
              },
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: {
                  usePointStyle: true,
                  pointStyle: "circle",
                },
              },
            },
            scales: {
              display: false,
            },
          },
        });
      });
    </script>
  </div>

  <!-- Calendar, Sticky Notes and List of Admins -->
  <div class="row px-3">
    <!-- List of Admins -->
    <div class="col-md-4 mb-3">
      <div
        class="card border-0 rounded shadow-sm h-100"
        style="padding-bottom: 5px"
      >
        {% if current_user.is_admin %}
        <h5 class="card-title px-3 mt-3">All Admins</h5>
        <div class="card-body" style="max-height: 250px; overflow-y: auto">
          {% for user in people_list %}
          <div class="row align-items-center mb-3">
            <div class="col-md-3 col-4">
                {% set profile_image = user.profile_image if user.profile_image is not none else url_for('static', filename='images/user.png') %}
                <img
                  src="{{ profile_image }}"
                  alt="{{ user.first_name|title }}'s Profile Image"
                  class="rounded-circle img-fluid profile-image"
                  style="width: 40px; height: 40px; object-fit: cover"
                />
            </div>
            <div class="col-md-7 col-6">
              <div>
                <h6 class="mb-0">
                  {{ user.first_name|title }} {{ user.last_name|title }}
                </h6>
                {% if user.last_login is not none and user.last_logout is not
                none %} {% if user.last_login > user.last_logout %}
                <p class="text-success small mb-0 fst-italic">Active now</p>
                {% elif user.last_logout > user.last_login %} {% set
                time_difference = now - user.last_logout %} {% if
                time_difference.days > 0 %} {% set time_unit = 'days' %}
                <p class="text-muted small mb-0 fst-italic">
                  Active {{ time_difference.days }} {{ time_unit }} ago
                </p>
                {% elif time_difference.seconds // 3600 > 0 %} {% set time_unit
                = 'hours' %}
                <p class="text-muted small mb-0 fst-italic">
                  Active {{ time_difference.seconds // 3600 }} {{ time_unit }}
                  ago
                </p>
                {% else %} {% set time_unit = 'minutes' %}
                <p class="text-muted small mb-0 fst-italic">
                  Active {{ time_difference.seconds // 60 }} {{ time_unit }} ago
                </p>
                {% endif %} {% endif %} {% endif %}
              </div>
            </div>
            <div class="col-md-2 col-2 text-end">
              <a
                href="{{ url_for('accounts.people.edit_user', user_id=user.id) }}"
                class="{% if user.last_login is not none and user.last_logout is not none %}{% if user.last_login > user.last_logout %}text-success{% elif user.last_logout > user.last_login %}text-secondary{% endif %}{% endif %}"
              >
                <ion-icon name="ellipse"></ion-icon>
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Calendar -->
    <div class="col-md-4 mb-3">
      <div class="card border-0 rounded shadow-sm h-100">
        <div class="card-body p-0">
          <div class="bg-info text-white text-center py-3">
            <span id="currentMonth" class="fw-bold fs-5"></span>
          </div>
          <div class="d-flex text-center bg-warning">
            <div class="col">Sun</div>
            <div class="col">Mon</div>
            <div class="col">Tue</div>
            <div class="col">Wed</div>
            <div class="col">Thu</div>
            <div class="col">Fri</div>
            <div class="col">Sat</div>
          </div>
          <div id="calendarDays" class="p-3"></div>
        </div>
      </div>
    </div>

    <!-- Sticky Notes -->
    <div class="col-md-4 mb-3">
      <div
        class="card border-0 rounded shadow-sm h-100"
        style="background-color: rgba(255, 224, 146, 0.5)"
      >
        <div class="card-body">
          <h5 class="card-title mb-4 border-bottom border-dark rounded">
            Sticky Note
          </h5>
          <form
            method="post"
            action="{{ url_for('accounts.dashboard.save_sticky_note') }}"
            id="sticky-note-form"
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <textarea
              id="sticky-note-input"
              name="content"
              class="form-control border-0 text-start sticky-note"
              style="resize: none; height: 150px; background-color: transparent"
              placeholder="Type your notes here..."
            >{% for note in sticky_note_content %}{% if note.user_id == current_user.id %}{{ note.content }}{% endif %}{% endfor %}</textarea>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delinquent Invoices Table -->
  <div class="col-md-12 mb-3 px-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title mb-4">Delinquent Invoices</h5>
        <div class="table-responsive">
          <table class="table table-borderless data-table">
            <!-- Table Headings -->
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Section</th>
                <th>House#</th>
                <th>Usage</th>
                <th>Subtotal</th>
                <th>Service</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %} {% if not invoice.reading_status %}
              <tr>
                <td>{{ loop.index }}</td>
                <td class="text-start">
                  {{ invoice.customer_name.split()[0]|title }}
                </td>
                <td>{{ invoice.house_section.title }}</td>
                <td>{{ invoice.house_number }}</td>
                <td>{{ "%0.0f"|format(invoice.consumed) }}</td>
                <td>{{ "%0.0f"|format(invoice.sub_total_price) }}</td>
                <td>{{ "%0.0f"|format(invoice.service_fee) }}</td>
                <td>{{ "%0.0f"|format(invoice.total_price) }}</td>
              </tr>
              {% endif %} {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- A Calendar -->
<script>
  // Function to generate and update the calendar
  function generateCalendar() {
    // Get current date
    const currentDate = new Date();

    // Get month and year
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();

    // Update month header
    document.getElementById("currentMonth").textContent = `${getMonthName(
      currentMonth
    )} ${currentYear}`;

    // Get the first day of the month
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);

    // Get the day of the week for the first day of the month (0 = Sunday, 1 = Monday, ...)
    const firstDayOfWeek = firstDayOfMonth.getDay();

    // Clear the previous calendar days
    const calendarDays = document.getElementById("calendarDays");
    calendarDays.innerHTML = "";

    // Get the number of days in the previous month
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

    // Create calendar days
    let day = 1 - firstDayOfWeek; // Start from the first day of the week in the current month
    for (let i = 0; i < 6; i++) {
      // Create row
      const row = document.createElement("div");
      row.classList.add("row", "text-center");

      // Create columns for each day of the week
      for (let j = 0; j < 7; j++) {
        const col = document.createElement("div");
        col.classList.add("col");

        // If the current day is in the previous month or the next month, display the corresponding day
        if (day <= 0 || day > getDaysInMonth(currentMonth, currentYear)) {
          col.textContent =
            day <= 0
              ? daysInPrevMonth + day
              : day - getDaysInMonth(currentMonth, currentYear);
          col.classList.add("text-muted");
        } else {
          col.textContent = day;
          if (day === currentDate.getDate()) {
            col.classList.add("bg-info", "rounded", "bg-opacity-50");
          }
        }

        row.appendChild(col);
        day++;
      }

      calendarDays.appendChild(row);
    }
  }

  // Function to get the number of days in a month
  function getDaysInMonth(month, year) {
    return new Date(year, month + 1, 0).getDate();
  }

  // Function to get the name of the month
  function getMonthName(month) {
    const months = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December",
    ];
    return months[month];
  }

  // Call the generateCalendar function to initially generate the calendar
  generateCalendar();
</script>

<!-- Sticky Notes -->
<script>
  let timeoutId;

  document.querySelectorAll(".sticky-note").forEach((textarea) => {
    textarea.addEventListener("input", function () {
      clearTimeout(timeoutId);

      timeoutId = setTimeout(() => {
        document.getElementById("sticky-note-form").submit();
      }, 2500);
    });
  });
</script>

{% endblock %}
